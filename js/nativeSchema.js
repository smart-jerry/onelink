/* * @author Alan * @date 2016-08-03 * @overview 测试在浏览器中打开native App; */(function (root, factory) {	'use strict';	if (typeof define === 'function' && define.amd) {		// AMD		define([], factory);	} else if (typeof exports === 'object') {		// Node, CommonJS-like		module.exports = factory();	} else {		root.nativeSchema = factory();	}}(this, function () {	var ua_main = navigator.userAgent.toLowerCase();	var platform = function (os) {		var ver = ('' + (new RegExp(os + '(\\d+((\\.|_)\\d+)*)').exec(ua_main) || [, 0])[1]).replace(/_/g, '.');		//// undefined < 3 === false, but null < 3 === true		return !!parseFloat(ver);	};	// UA鉴定	var browser = {		isAndroid: function () {			return platform('android[/ ]');		},		isMobileQQ: function () {			var ua = navigator.userAgent;			return /(iPad|iPhone|iPod).*? (IPad)?QQ\/([\d\.]+)/.test(ua) || /\bV1_AND_SQI?_([\d\.]+)(.*? QQ\/([\d\.]+))?/.test(ua);		},		isIOS: function () {			return platform('os ');		},		isWx: function () {			return navigator.userAgent.match(/micromessenger/i) ? true : false;		},		isPC: function () {			return !platform('os ') && !platform('android[/ ]');		}	};	var AppConfig = {		// 协议头		PROTOCOL: "jollychic://",		// 主页		HOME: "home",		// 唤起失败时的跳转链接		FAILBACK: {			ANDROID: "https://play.google.com/store/apps/details?id=com.jollycorp.jollychic&referrer=utm_source%3Dwww.jollychic.com%26utm_medium%3Dreferral",			IOS: "https://itunes.apple.com/app/jollychic-affordable-fashion/id944846798?mt=8",			MOBILE: "",			APP: ""		},		// Android apk 相关信息		APK_INFO: {			PKG: "com.jollycorp.jollychic",			CATEGORY: "android.intent.category.DEFAULT",			ACTION: "android.intent.action.VIEW"		},		// 唤起超时时间，超时则跳转到下载页面		LOAD_WAITING: 3000	};	var ua = window.navigator.userAgent;	// 是否为Android下的chrome浏览器，排除mobileQQ；	// Android下的chrome，需要通过特殊的intent 来唤醒	// refer link：https://developer.chrome.com/multidevice/android/intents	var isAndroidChrome = (ua.match(/Chrome\/([\d.]+)/) || ua.match(/CriOS\/([\d.]+)/))		&& browser.isAndroid() && !browser.isMobileQQ();	//facebook	var isFB = /FBAV\/([\d.]+)/.test(ua);	//var chromeVersion = Number(((ua.match(/Chrome\/([\d.]+)/)[1]).split('.'))[0]);	var urlParseRE = /^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/;	var regUrl = function (url) {		var localUrl = url || document.URL;		return localUrl.match(urlParseRE);	};	/**	 * url json	 */	var jsonUrlParams = function (url, bool) {		this.url = url;		this.params = {}; //url参数对象		this.isEncode = bool || false;		this.init();	};	jsonUrlParams.prototype = {		init: function () {			var str = this.url;			if (str) {				var index = str.indexOf("?");				//修复有#号的bug				if (index > 0) {					str = str.substr(index);					index = str.indexOf("?");				}				if (index === 0) {					str = str.substr(index + 1);					//eg.?utm_source=newsletter%26utm_medium=email%26utm_campaign=newsletter20130507_brands&mailid=ZC3715-FHD2XDx~XjSnZQVUmOlRL35&spam=0					var sKey = this.isEncode ? encodeURIComponent("&") : "&";					var parts = str.split(sKey);					for (var i = 0, len = parts.length; i < len; i++) {						var kv = parts[i];						if (kv.indexOf("&") > 0) {							var keys = parts[i].split("&");							for (var j = 0, l = keys.length; j < l; j++) {								var key = keys[j].split("=");								this.params[key[0]] = key[1];							}						} else {							var key = kv.split("=");							this.params[key[0]] = key[1];						}					}				}			}		},		//get value		get: function (key) {			return this.params[key];		}	};	return {		/**		 * [mixinConfig 重新收拢配置]		 * @param  {[type]} config [description]		 * @return {[type]}        [description]		 */		mixinConfig: function (config) {			if (!config) {				return true;			}			AppConfig.PROTOCOL = config.protocol || AppConfig.PROTOCOL;			AppConfig.LOAD_WAITING = config.loadWaiting || AppConfig.LOAD_WAITING;			if (browser.isIOS()) {				AppConfig.FAILBACK.IOS = config.failIosUrl || AppConfig.FAILBACK.IOS;				AppConfig.FAILBACK.APP = AppConfig.FAILBACK.IOS;			} else if (browser.isAndroid()) {				AppConfig.FAILBACK.ANDROID = config.failAndroidUrl || AppConfig.FAILBACK.ANDROID;				AppConfig.FAILBACK.APP = AppConfig.FAILBACK.ANDROID;				AppConfig.APK_INFO = config.apkInfo || AppConfig.APK_INFO;			}		},		/**		 * [generateSchema 根据不同的场景及UA生成最终应用的schema]		 * @return {[String]}		 */		generateSchema: function () {			//正则匹配规则			var paramsStr = regUrl()[16] || regUrl()[17] || "";			var thisUrl = new jsonUrlParams(paramsStr);			//将特殊符号替换			var regWap = /\'/g;			var jy_url_app = thisUrl.get('jy_url_app') ? decodeURIComponent(thisUrl.get('jy_url_app')) : null; // go to app url			var jy_url_wap = thisUrl.get('jy_url_wap') ? decodeURIComponent(thisUrl.get('jy_url_wap')).replace(regWap, "-") : null; // go to wap url			var jy_down = thisUrl.get('jy_down') ? decodeURIComponent(thisUrl.get('jy_down')) : null;			var zy_cv = thisUrl.get('zy_cv') ? decodeURIComponent(thisUrl.get('zy_cv')) : null;			var jy_other = thisUrl.get('jy_other') ? decodeURIComponent(thisUrl.get('jy_other')) : "d=default";			var is_webview = thisUrl.get('is_webview') ? true : false; //是否是webview,做特殊处理			//App_Share|Referral|Userid|(not set)|(not set)			//utm_source|utm_medium|utm_campaign|utm_adgroup|utm_content			var schemaStr = jy_url_app ? (jy_url_app.split(AppConfig.PROTOCOL)[1] ? jy_url_app.split(AppConfig.PROTOCOL)[1] : "" ) : "";			//如果存在m站地址,跳转m站的地址配置上			if (jy_url_wap) {				//针对m站参数进行拆解				var html = "";				var zy_cv_arr = [];				var zy_cv_arr_key;				if (zy_cv) {					zy_cv_arr_key = ["utm_source", "utm_medium", "utm_campaign", "utm_adgroup", "utm_content"];					zy_cv_arr = zy_cv.split("|");					for (var i = 0; i < zy_cv_arr.length; i++) {						if (zy_cv_arr_key[i]) {							html += "&" + zy_cv_arr_key[i] + "=" + zy_cv_arr[i];						}					}				}				if (jy_url_wap.indexOf('?') > 0) {					jy_url_wap += "&frm_auto=auto_link&zy_cv=" + encodeURIComponent(zy_cv) + "&jy_other=" + encodeURIComponent(jy_other);					jy_url_wap += html;				} else {					jy_url_wap += "?frm_auto=auto_link&zy_cv=" + encodeURIComponent(zy_cv) + "&jy_other=" + encodeURIComponent(jy_other);					jy_url_wap += html;				}				AppConfig.FAILBACK.MOBILE = jy_url_wap;			}			if (browser.isPC()) {				//配置好PC站地址				if (jy_down) {					schemaStr = "http://www.jollychic.com/special-appDown20151215-index.html";				} else {					schemaStr = AppConfig.FAILBACK.MOBILE;				}			} else {				if (is_webview) {					schemaStr = AppConfig.PROTOCOL + schemaStr;				} else {					schemaStr = AppConfig.PROTOCOL + schemaStr + "?zy_cv=" + encodeURIComponent(zy_cv) + "&" + jy_other;				}			}			//alert(schemaStr);			return schemaStr;		},		/**		 * [loadSchema 唤醒native App，如果无法唤醒，则跳转到下载页]		 * @return {[type]} [description]		 */		loadSchema: function (config) {			this.mixinConfig(config);			var schemaUrl = this.generateSchema();			if (!schemaUrl) {				return false;			}			var iframe = document.createElement("iframe"),				aLink = document.createElement("a"),				body = document.body;			var timeout, t = 1000, t1, hasApp = true;			var timeoutRun = null;			setTimeout(function () {				if (hasApp) {					//alert('安装了app');					if (typeof(TrackLog) != "undefined" && typeof(TrackLog.trackLogSend) != "undefined") {						TrackLog.trackLogSend({							"_type": "pv_debug",							"_info": {								"src": schemaUrl,								"install": "yes"							}						}, true);					}				} else {					//统一优先跳转m站,然后才是下载页面					window.location.href = AppConfig.FAILBACK.MOBILE || AppConfig.FAILBACK.APP;					//alert('未安装app');					if (typeof(TrackLog) != "undefined" && typeof(TrackLog.trackLogSend) != "undefined") {						TrackLog.trackLogSend({							"_type": "pv_debug",							"_info": {								"src": schemaUrl,								"install": "no"							}						}, true);					}				}				clearTimeout(timeoutRun);				if (isAndroidChrome) {					if (isFB) {						body.removeChild(iframe);					} else {						body.removeChild(aLink);					}				}			}, AppConfig.LOAD_WAITING);			timeoutRun = setTimeout(function () {				t1 = Date.now();				if (isAndroidChrome) {					if (isFB) {						body.appendChild(iframe);						iframe.src = schemaUrl;					} else {						body.appendChild(aLink);						aLink.href = schemaUrl;						aLink.click();					}				} else {					window.location.href = schemaUrl;				}			}, 30);			timeout = setTimeout(function () {				var t2 = Date.now();				if (!t1 || t2 - t1 < t + 100) {					hasApp = false;				}			}, t);		}	}}));